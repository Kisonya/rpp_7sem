# Импортируем Flask — это микрофреймворк для создания веб-приложений.
from flask import Flask, jsonify

# Модуль socket нужен, чтобы узнать имя компьютера (хоста).
import socket

# Модуль sys позволяет получать аргументы, переданные при запуске программы.
import sys

# Создаём объект приложения Flask.
app = Flask(__name__)

# Получаем порт, который передаётся при запуске программы.
# Например: python app_instance.py 5001
# Если порт не указан, то по умолчанию используем 5001.
port = int(sys.argv[1]) if len(sys.argv) > 1 else 5001


@app.route('/health')
def health():
    """
    Эндпоинт /health.
    Возвращает информацию о состоянии данного инстанса.
    Используется балансировщиком, чтобы понять — сервер доступен или нет.
    """
    return jsonify({
        # Возвращаем имя хоста и порт, чтобы можно было понять, кто ответил.
        "instance": f"{socket.gethostname()}:{port}",
        # Статус — просто строка, сообщающая, что инстанс "жив".
        "status": "healthy"
    })


@app.route('/process')
def process():
    """
    Эндпоинт /process.
    Симулирует обработку запроса.
    В реальном проекте здесь могла бы быть бизнес-логика (например, расчёты).
    """
    return jsonify({
        "message": f"Processed by instance on port {port}"
    })


# Эта конструкция гарантирует, что приложение запустится
# только при прямом запуске этого файла (а не при импорте).
if __name__ == '__main__':
    # Запускаем Flask-приложение на указанном порту.
    # По умолчанию — localhost, чтобы не было внешнего доступа.
    app.run(port=port)
